<h1>Live Chat</h1>

<!-- Chat box and form -->
<div id="chat-box" style="border:1px solid #ccc; height:300px; overflow-y:scroll; margin-bottom:10px;"></div>

<!-- Message input form -->
<form id="chat-form">
  <input id="chat-input" autocomplete="off" placeholder="Type a message..." required>
  <button type="submit">Send</button>
</form>

<!-- Socket.IO client library -->
<script src="/socket.io/socket.io.js"></script>
<script>

  //socket.io initialization
  const socket = io();
  const chatBox = document.getElementById("chat-box");
  const form = document.getElementById("chat-form");
  const input = document.getElementById("chat-input");

//render a message in the chat box
function addMessage(msg) {
  const div = document.createElement("div");
  const time = new Date(msg.created_at).toLocaleTimeString();
  const nameSpan = document.createElement("span");
  nameSpan.textContent = msg.display_name;
  nameSpan.style.color = msg.name_color || "#FFFACD";

  const msgSpan = document.createElement("span");
  msgSpan.textContent = `: ${msg.message}`;

  //assemble the message
  div.append(`[${time}] `);
  div.appendChild(nameSpan);
  div.appendChild(msgSpan);

  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

//load existing chat history
fetch("/api/chat/history")
    .then(res => res.json())
    .then(messages => {
      messages.forEach(addMessage);
    });

//real time chat updates
socket.on("chat:new", addMessage);

//send a new chat message
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const message = input.value.trim();
    if (!message) return;
    input.value = "";

    await fetch("/api/chat/message", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ message })
    });
  });
</script>
